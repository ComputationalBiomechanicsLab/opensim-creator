cmake_minimum_required(VERSION 3.10)
project(osc-dependencies)

include(ExternalProject)  # ExternalProject_Add
include(GNUInstallDirs)   # CMAKE_INSTALL_LIBDIR

option(OSCDEPS_BUILD_OPYNSIM "Build opynsim"         ON)
option(OSCDEPS_BUILD_OSCAR   "Build oscar"           ON)

# set OSCDEPS_BUILD_ALWAYS
if(TRUE)
    set(OSCDEPS_BUILD_ALWAYS_DOCS "set BUILD_ALWAYS on all dependency targets, useful when editing dependencies")
    if(DEFINED ENV{OSCDEPS_BUILD_ALWAYS})
        set(OSCDEPS_BUILD_ALWAYS "$ENV{OSCDEPS_BUILD_ALWAYS}" CACHE BOOL "${OSCDEPS_BUILD_ALWAYS_DOCS}" FORCE)
    else()
        set(OSCDEPS_BUILD_ALWAYS OFF CACHE BOOL "${OSCDEPS_BUILD_ALWAYS_DOCS}")
    endif()
    unset(OSCDEPS_BUILD_ALWAYS_DOCS)
endif()

# setup `OSCDEPS_DEPENDENCY_CMAKE_ARGS`
#
# these are cache args that should be forwarded to external dependency projects
if(TRUE)
    set(OSCDEPS_FORWARDED_VARS

        CMAKE_CXX_COMPILER
        CMAKE_C_COMPILER
        CMAKE_CXX_FLAGS
        CMAKE_CXX_FLAGS_DEBUG
        CMAKE_CXX_FLAGS_MINSIZEREL
        CMAKE_CXX_FLAGS_RELEASE
        CMAKE_CXX_FLAGS_RELWITHDEBINFO
        CMAKE_CXX_VISIBILITY_PRESET
        CMAKE_C_FLAGS
        CMAKE_C_FLAGS_DEBUG
        CMAKE_C_FLAGS_MINSIZEREL
        CMAKE_C_FLAGS_RELEASE
        CMAKE_C_FLAGS_RELWITHDEBINFO
        CMAKE_C_VISIBILITY_PRESET
        CMAKE_BUILD_TYPE
        CMAKE_INSTALL_PREFIX
        CMAKE_TOOLCHAIN_FILE
        CMAKE_OSX_SYSROOT
        CMAKE_SYSTEM_VERSION
        CMAKE_OSX_DEPLOYMENT_TARGET
        CMAKE_OSX_ARCHITECTURES
        CMAKE_POSITION_INDEPENDENT_CODE
    )
    foreach(OSCDEPS_FORWARDED_VAR IN LISTS OSCDEPS_FORWARDED_VARS)
        if (DEFINED ${OSCDEPS_FORWARDED_VAR})
            list(APPEND OSCDEPS_DEPENDENCY_CMAKE_ARGS -D${OSCDEPS_FORWARDED_VAR}:STRING=${${OSCDEPS_FORWARDED_VAR}})
        endif()
    endforeach()
    unset(OSCDEPS_FORWARDED_VARS)
endif()

if(OSCDEPS_BUILD_OPYNSIM)
    ExternalProject_Add(opyndeps
        SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/opynsim/third_party
        BUILD_ALWAYS ${OSCDEPS_BUILD_ALWAYS}
        INSTALL_COMMAND ""
        CMAKE_CACHE_ARGS
            ${OSCDEPS_DEPENDENCY_CMAKE_ARGS}
            -DBUILD_TESTING:BOOL=OFF
            -DOPYNDEPS_BUILD_ROBIN_MAP:BOOL=OFF
    )
    ExternalProject_Add(opynsim
        DEPENDS opyndeps
        SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/opynsim
        BUILD_ALWAYS ${OSCDEPS_BUILD_ALWAYS}
        CMAKE_CACHE_ARGS
            ${OSCDEPS_DEPENDENCY_CMAKE_ARGS}
            -DCMAKE_PREFIX_PATH:PATH=${CMAKE_INSTALL_PREFIX}
            -DBUILD_TESTING:BOOL=OFF
            -DOPYN_BUILD_PYTHON_BINDINGS:BOOL=OFF
            -DOPYN_BUILD_DOCS:BOOL=OFF
            -DOPYN_USE_STRICT_COMPILER_FLAGS:BOOL=OFF
            -DOPYN_PACKAGE:BOOL=OFF
    )
endif()

if(OSCDEPS_BUILD_OSCAR)
    ExternalProject_Add(oscdeps
        SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/oscar/third_party
        BUILD_ALWAYS ${OSCDEPS_BUILD_ALWAYS}
        INSTALL_COMMAND ""
        CMAKE_CACHE_ARGS
            ${OSCDEPS_DEPENDENCY_CMAKE_ARGS}
            -DBUILD_TESTING:BOOL=OFF
    )
    ExternalProject_Add(oscar
        DEPENDS oscdeps
        SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/oscar
        BUILD_ALWAYS ${OSCDEPS_BUILD_ALWAYS}
        CMAKE_CACHE_ARGS
            ${OSCDEPS_DEPENDENCY_CMAKE_ARGS}
            -DCMAKE_PREFIX_PATH:PATH=${CMAKE_INSTALL_PREFIX}
            -DBUILD_TESTING:BOOL=OFF
            -DOSCAR_BUILD_HELLOOSCAR:BOOL=OFF
    )
endif()

// The reason <Python.h> is included this way is because Visual Studio will
// look for (e.g.) `python313_d.lib` if building in debug mode, which won't
// work for typical installs of python
#ifdef _DEBUG
    #undef _DEBUG
    #include <Python.h>
    #define _DEBUG
#else
    #include <Python.h>
#endif

#include <cstdlib>
#include <string>

#if defined(_WIN32)
    #include <direct.h>
    #define chdir _chdir
#else
    #include <unistd.h>
#endif

int main() {
    // Set working directory to the project root directory
    if (chdir("@CMAKE_CURRENT_SOURCE_DIR@") != 0) {
        perror("chdir failed");
        return 1;
    }

    // Set PYTHONPATH so that Python finds the `opynsim` package
#if defined(_WIN32)
    _putenv("PYTHONPATH=@CMAKE_CURRENT_SOURCE_DIR@");
#else
    setenv("PYTHONPATH", "@CMAKE_CURRENT_SOURCE_DIR@", 1);
#endif

    // This is roughly equivalent to running `python -m opynsim` in the terminal
    Py_Initialize();    
    std::string code =
        "import runpy\n"
        "runpy.run_module('opynsim', run_name='__main__')\n";
    int result = PyRun_SimpleString(code.c_str());
    Py_Finalize();
    return result;
}
